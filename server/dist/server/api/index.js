/// <reference path="../../../typings/index.d.ts" />
"use strict";
var database_schema_1 = require('../database/database.schema');
var ApiComponent = (function () {
    function ApiComponent() {
        var _this = this;
        this.request = function (req, res, type) {
            if (type == 'login') {
                _this.login(req, res);
            }
            else if (type == 'register') {
                _this.register(req, res);
            }
        };
    }
    ApiComponent.prototype.login = function (data, res) {
        var userCred = new Buffer(data, 'base64').toString().split('::');
        database_schema_1.User.findOne({ UserName: userCred[0] }, function (err, user) {
            if (err) {
                console.log('user ' + userCred[0] + ' not found or error:' + err);
                res.send({ status: 404, data: "Not found" });
            }
            console.log(user);
            if (!user) {
                console.log('user ' + userCred[0] + ' not found');
                res.send({ status: 404, data: "Not found" });
            }
            user.comparePassword(userCred[1], function (err, isMatch) {
                if (err) {
                    console.log('user ' + userCred[0] + ' not password compare error:' + err);
                    res.send({ status: 500, data: "password error" });
                }
                if (isMatch) {
                    var token = new Buffer(user.UserName + "::" + user.Password, 'base64').toString();
                    delete user.Password;
                    res.send({ status: 200, data: { user: user, token: token } });
                }
                else {
                    res.send({ status: 403, data: "Password does not match" });
                }
            });
        });
    };
    ApiComponent.prototype.register = function (data, res) {
        console.log(data);
        var userRegister = new Buffer(data, 'base64').toString().split('::');
        console.log(userRegister);
        var unlockables = new database_schema_1.Unlockables({
            Bikes: [],
            Textures: [],
            Guns: []
        });
        var gameStats = new database_schema_1.GameStats({
            Won: 0,
            Played: 0,
            Badges: []
        });
        var user = new database_schema_1.User({
            UserName: userRegister[0],
            Password: userRegister[1],
            Email: userRegister[2],
            GameStats: gameStats,
            Unlockables: unlockables
        });
        user.save(function (err, user) {
            if (err) {
                console.log('Could not save player: ' + err);
                res.send({ status: 500, data: "Not Saved" });
            }
            console.log("Saved: ");
            console.dir(user);
            res.send({ status: 201, data: "Saved" });
        });
    };
    return ApiComponent;
}());
exports.ApiComponent = ApiComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci9hcGkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsb0RBQW9EOztBQUtwRCxnQ0FBNkMsNkJBQTZCLENBQUMsQ0FBQTtBQUUzRTtJQUNJO1FBREosaUJBZ0ZDO1FBM0VHLFlBQU8sR0FBRyxVQUFDLEdBQVEsRUFBRSxHQUFxQixFQUFFLElBQVk7WUFDcEQsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ2xCLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3pCLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLENBQUM7UUFDTCxDQUFDLENBQUM7SUFSRixDQUFDO0lBVUQsNEJBQUssR0FBTCxVQUFPLElBQVMsRUFBRSxHQUFxQjtRQUNuQyxJQUFNLFFBQVEsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRW5FLHNCQUFJLENBQUMsT0FBTyxDQUFDLEVBQUMsUUFBUSxFQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBQyxFQUFFLFVBQVUsR0FBRyxFQUFFLElBQUk7WUFDdEQsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsc0JBQXNCLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQ2xFLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUMsQ0FBQyxDQUFBO1lBQzlDLENBQUM7WUFD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eUIsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDN0MsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBQyxDQUFDLENBQUE7WUFDOUMsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFDLENBQUMsQ0FBQTtRQUMxQyxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFDTCxtQkFBQztBQUFELENBaEZBLEFBZ0ZDLElBQUE7QUFoRlksb0JBQVksZUFnRnhCLENBQUEiLCJmaWxlIjoic2VydmVyL2FwaS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL2luZGV4LmQudHNcIiAvPlxuXG5pbXBvcnQgZXhwcmVzcyA9IHJlcXVpcmUoXCJleHByZXNzXCIpO1xuaW1wb3J0IG1vbmdvb3NlID0gcmVxdWlyZShcIm1vbmdvb3NlXCIpO1xuXG5pbXBvcnQgeyBVc2VyLCBHYW1lU3RhdHMsIFVubG9ja2FibGVzIH0gZnJvbSAnLi4vZGF0YWJhc2UvZGF0YWJhc2Uuc2NoZW1hJztcblxuZXhwb3J0IGNsYXNzIEFwaUNvbXBvbmVudCB7XG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICB9XG5cbiAgICByZXF1ZXN0ID0gKHJlcTogYW55LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIHR5cGU6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAodHlwZSA9PSAnbG9naW4nKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2luKHJlcSwgcmVzKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICdyZWdpc3RlcicpIHtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXIocmVxLHJlcyk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbG9naW4gKGRhdGE6IGFueSwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IHVzZXJDcmVkID0gbmV3IEJ1ZmZlcihkYXRhLCAnYmFzZTY0JykudG9TdHJpbmcoKS5zcGxpdCgnOjonKTtcblxuICAgICAgICBVc2VyLmZpbmRPbmUoe1VzZXJOYW1lIDogdXNlckNyZWRbMF19LCBmdW5jdGlvbiAoZXJyLCB1c2VyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3VzZXIgJyArIHVzZXJDcmVkWzBdICsgJyBub3QgZm91bmQgb3IgZXJyb3I6JyArIGVycik7XG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogNDA0LCBkYXRhOiBcIk5vdCBmb3VuZFwifSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHVzZXIpO1xuICAgICAgICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3VzZXIgJyArIHVzZXJDcmVkWzBdICsgJyBub3QgZm91bmQnKTtcbiAgICAgICAgICAgICAgICByZXMuc2VuZCh7c3RhdHVzOiA0MDQsIGRhdGE6IFwiTm90IGZvdW5kXCJ9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB1c2VyLmNvbXBhcmVQYXNzd29yZCh1c2VyQ3JlZFsxXSwgZnVuY3Rpb24oZXJyLCBpc01hdGNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndXNlciAnICsgdXNlckNyZWRbMF0gKyAnIG5vdCBwYXNzd29yZCBjb21wYXJlIGVycm9yOicgKyBlcnIpO1xuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZCh7c3RhdHVzOiA1MDAsIGRhdGE6IFwicGFzc3dvcmQgZXJyb3JcIn0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpc01hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRva2VuID0gbmV3IEJ1ZmZlcih1c2VyLlVzZXJOYW1lICsgXCI6OlwiICsgdXNlci5QYXNzd29yZCwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB1c2VyLlBhc3N3b3JkO1xuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZCh7c3RhdHVzOiAyMDAsIGRhdGE6IHt1c2VyIDogdXNlciwgdG9rZW4gOiB0b2tlbn19KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKHtzdGF0dXM6IDQwMywgZGF0YTogXCJQYXNzd29yZCBkb2VzIG5vdCBtYXRjaFwifSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICByZWdpc3RlciAoZGF0YTogYW55LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgIGNvbnN0IHVzZXJSZWdpc3RlciA9IG5ldyBCdWZmZXIoZGF0YSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkuc3BsaXQoJzo6Jyk7XG4gICAgICAgIGNvbnNvbGUubG9nKHVzZXJSZWdpc3Rlcik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB1bmxvY2thYmxlcyA9IG5ldyBVbmxvY2thYmxlcyh7XG4gICAgICAgICAgICBCaWtlcyA6IFtdLFxuICAgICAgICAgICAgVGV4dHVyZXMgOiBbXSxcbiAgICAgICAgICAgIEd1bnMgOiBbXSxcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBnYW1lU3RhdHMgPSBuZXcgR2FtZVN0YXRzKHtcbiAgICAgICAgICAgIFdvbiA6IDAsXG4gICAgICAgICAgICBQbGF5ZWQgOiAwLFxuICAgICAgICAgICAgQmFkZ2VzIDogW11cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKHtcbiAgICAgICAgICAgIFVzZXJOYW1lOiB1c2VyUmVnaXN0ZXJbMF0sXG4gICAgICAgICAgICBQYXNzd29yZDogdXNlclJlZ2lzdGVyWzFdLFxuICAgICAgICAgICAgRW1haWw6IHVzZXJSZWdpc3RlclsyXSxcbiAgICAgICAgICAgIEdhbWVTdGF0czogZ2FtZVN0YXRzLFxuICAgICAgICAgICAgVW5sb2NrYWJsZXMgOiB1bmxvY2thYmxlc1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHVzZXIuc2F2ZShmdW5jdGlvbiAoZXJyLCB1c2VyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NvdWxkIG5vdCBzYXZlIHBsYXllcjogJyArIGVycik7XG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogNTAwLCBkYXRhOiBcIk5vdCBTYXZlZFwifSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTYXZlZDogXCIpO1xuICAgICAgICAgICAgY29uc29sZS5kaXIodXNlcik7XG4gICAgICAgICAgICByZXMuc2VuZCh7c3RhdHVzOiAyMDEsIGRhdGE6IFwiU2F2ZWRcIn0pXG4gICAgICAgIH0pXG4gICAgfVxufSJdfQ==
