/// <reference path="../../../typings/index.d.ts" />
"use strict";
var database_schema_1 = require('../database/database.schema');
var ApiComponent = (function () {
    function ApiComponent() {
        var _this = this;
        this.request = function (req, res, type) {
            if (type == 'login') {
                _this.login(req, res);
            }
            else if (type == 'register') {
                _this.register(req, res);
            }
        };
    }
    ApiComponent.prototype.login = function (data, res) {
        var userCred = new Buffer(data, 'base64').toString().split('::');
        database_schema_1.User.findOne({ UserName: userCred[0] }, function (err, user) {
            if (err) {
                console.log('user ' + userCred[0] + ' not found or error:' + err);
                res.send({ status: 404, data: "Not found" });
            }
            if (!user) {
                console.log('user ' + userCred[0] + ' not found');
                res.send({ status: 404, data: "Not found" });
                return;
            }
            user.comparePassword(userCred[1], function (err, isMatch) {
                if (err) {
                    console.log('user ' + userCred[0] + ' not password compare error:' + err);
                    res.send({ status: 500, data: "password error" });
                }
                if (isMatch) {
                    var token = new Buffer(user.UserName + "::" + user.Password, 'base64').toString();
                    delete user.Password;
                    res.send({ status: 200, data: { user: user, token: token } });
                    return;
                }
                else {
                    res.send({ status: 403, data: "Password does not match" });
                }
            });
        });
    };
    ApiComponent.prototype.register = function (data, res) {
        console.log(data);
        var userRegister = new Buffer(data, 'base64').toString().split('::');
        console.log(userRegister);
        var unlockables = new database_schema_1.Unlockables({
            Bikes: [],
            Textures: [],
            Guns: []
        });
        var gameStats = new database_schema_1.GameStats({
            Won: 0,
            Played: 0,
            Badges: []
        });
        var user = new database_schema_1.User({
            UserName: userRegister[0],
            Password: userRegister[1],
            Email: userRegister[2],
            GameStats: gameStats,
            Unlockables: unlockables
        });
        user.save(function (err, user) {
            if (err) {
                console.log('Could not save player: ' + err);
                res.send({ status: 500, data: "Not Saved" });
            }
            console.log("Saved: ");
            console.dir(user);
            res.send({ status: 201, data: "Saved" });
        });
    };
    return ApiComponent;
}());
exports.ApiComponent = ApiComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZlci9hcGkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsb0RBQW9EOztBQUtwRCxnQ0FBNkMsNkJBQTZCLENBQUMsQ0FBQTtBQUUzRTtJQUNJO1FBREosaUJBaUZDO1FBNUVHLFlBQU8sR0FBRyxVQUFDLEdBQVEsRUFBRSxHQUFxQixFQUFFLElBQVk7WUFDcEQsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ2xCLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3pCLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNCLENBQUM7UUFDTCxDQUFDLENBQUM7SUFSRixDQUFDO0lBVUQsNEJBQUssR0FBTCxVQUFPLElBQVMsRUFBRSxHQUFxQjtRQUNuQyxJQUFNLFFBQVEsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRW5FLHNCQUFJLENBQUMsT0FBTyxDQUFDLEVBQUMsUUFBUSxFQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBQyxFQUFFLFVBQVUsR0FBRyxFQUFFLElBQUk7WUFDdEQsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsc0JBQXNCLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQ2xFLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUMsQ0FBQyxDQUFBO1lBQzlDLENBQUM7WUFD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QUFHLENBQUMsQ0FBQztnQkFDN0MsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBQyxDQUFDLENBQUE7WUFDOUMsQ0FBQztZQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFDLENBQUMsQ0FBQTtRQUMxQyxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFDTCxtQkFBQztBQUFELENBakZBLEFBaUZDLElBQUE7QUFqRlksb0JBQVksZUFpRnhCLENBQUEiLCJmaWxlIjoic2VydmVyL2FwaS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL2luZGV4LmQudHNcIiAvPlxuXG5pbXBvcnQgZXhwcmVzcyA9IHJlcXVpcmUoXCJleHByZXNzXCIpO1xuaW1wb3J0IG1vbmdvb3NlID0gcmVxdWlyZShcIm1vbmdvb3NlXCIpO1xuXG5pbXBvcnQgeyBVc2VyLCBHYW1lU3RhdHMsIFVubG9ja2FibGVzIH0gZnJvbSAnLi4vZGF0YWJhc2UvZGF0YWJhc2Uuc2NoZW1hJztcblxuZXhwb3J0IGNsYXNzIEFwaUNvbXBvbmVudCB7XG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICB9XG5cbiAgICByZXF1ZXN0ID0gKHJlcTogYW55LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIHR5cGU6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAodHlwZSA9PSAnbG9naW4nKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2luKHJlcSwgcmVzKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09ICdyZWdpc3RlcicpIHtcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXIocmVxLHJlcyk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbG9naW4gKGRhdGE6IGFueSwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IHVzZXJDcmVkID0gbmV3IEJ1ZmZlcihkYXRhLCAnYmFzZTY0JykudG9TdHJpbmcoKS5zcGxpdCgnOjonKTtcblxuICAgICAgICBVc2VyLmZpbmRPbmUoe1VzZXJOYW1lIDogdXNlckNyZWRbMF19LCBmdW5jdGlvbiAoZXJyLCB1c2VyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3VzZXIgJyArIHVzZXJDcmVkWzBdICsgJyBub3QgZm91bmQgb3IgZXJyb3I6JyArIGVycik7XG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogNDA0LCBkYXRhOiBcIk5vdCBmb3VuZFwifSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd1c2VyICcgKyB1c2VyQ3JlZFswXSArICcgbm90IGZvdW5kJyk7XG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogNDA0LCBkYXRhOiBcIk5vdCBmb3VuZFwifSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdXNlci5jb21wYXJlUGFzc3dvcmQodXNlckNyZWRbMV0sIGZ1bmN0aW9uKGVyciwgaXNNYXRjaCkge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3VzZXIgJyArIHVzZXJDcmVkWzBdICsgJyBub3QgcGFzc3dvcmQgY29tcGFyZSBlcnJvcjonICsgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogNTAwLCBkYXRhOiBcInBhc3N3b3JkIGVycm9yXCJ9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0b2tlbiA9IG5ldyBCdWZmZXIodXNlci5Vc2VyTmFtZSArIFwiOjpcIiArIHVzZXIuUGFzc3dvcmQsICdiYXNlNjQnKS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdXNlci5QYXNzd29yZDtcbiAgICAgICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogMjAwLCBkYXRhOiB7dXNlciA6IHVzZXIsIHRva2VuIDogdG9rZW59fSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcy5zZW5kKHtzdGF0dXM6IDQwMywgZGF0YTogXCJQYXNzd29yZCBkb2VzIG5vdCBtYXRjaFwifSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICByZWdpc3RlciAoZGF0YTogYW55LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgIGNvbnN0IHVzZXJSZWdpc3RlciA9IG5ldyBCdWZmZXIoZGF0YSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkuc3BsaXQoJzo6Jyk7XG4gICAgICAgIGNvbnNvbGUubG9nKHVzZXJSZWdpc3Rlcik7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB1bmxvY2thYmxlcyA9IG5ldyBVbmxvY2thYmxlcyh7XG4gICAgICAgICAgICBCaWtlcyA6IFtdLFxuICAgICAgICAgICAgVGV4dHVyZXMgOiBbXSxcbiAgICAgICAgICAgIEd1bnMgOiBbXSxcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBnYW1lU3RhdHMgPSBuZXcgR2FtZVN0YXRzKHtcbiAgICAgICAgICAgIFdvbiA6IDAsXG4gICAgICAgICAgICBQbGF5ZWQgOiAwLFxuICAgICAgICAgICAgQmFkZ2VzIDogW11cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgdXNlciA9IG5ldyBVc2VyKHtcbiAgICAgICAgICAgIFVzZXJOYW1lOiB1c2VyUmVnaXN0ZXJbMF0sXG4gICAgICAgICAgICBQYXNzd29yZDogdXNlclJlZ2lzdGVyWzFdLFxuICAgICAgICAgICAgRW1haWw6IHVzZXJSZWdpc3RlclsyXSxcbiAgICAgICAgICAgIEdhbWVTdGF0czogZ2FtZVN0YXRzLFxuICAgICAgICAgICAgVW5sb2NrYWJsZXMgOiB1bmxvY2thYmxlc1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHVzZXIuc2F2ZShmdW5jdGlvbiAoZXJyLCB1c2VyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NvdWxkIG5vdCBzYXZlIHBsYXllcjogJyArIGVycik7XG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoe3N0YXR1czogNTAwLCBkYXRhOiBcIk5vdCBTYXZlZFwifSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTYXZlZDogXCIpO1xuICAgICAgICAgICAgY29uc29sZS5kaXIodXNlcik7XG4gICAgICAgICAgICByZXMuc2VuZCh7c3RhdHVzOiAyMDEsIGRhdGE6IFwiU2F2ZWRcIn0pXG4gICAgICAgIH0pXG4gICAgfVxufSJdfQ==
